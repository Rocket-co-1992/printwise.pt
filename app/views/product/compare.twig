{% extends "layout/main.twig" %}

{% block title %}Comparar Produtos - PrintWise{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Início</a></li>
            <li class="breadcrumb-item"><a href="/product/categories">Categorias</a></li>
            <li class="breadcrumb-item active" aria-current="page">Comparar Produtos</li>
        </ol>
    </nav>

    <h1 class="mb-4">Comparar Produtos</h1>
    
    {% if products|length > 0 %}
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="bg-light">
                    <tr>
                        <th style="min-width: 200px;">Produto</th>
                        {% for product in products %}
                            <th style="min-width: 250px;" class="text-center">
                                <div class="position-relative">
                                    <button type="button" class="btn-close position-absolute top-0 end-0" 
                                            onclick="removeProduct('{{ product.id }}')" aria-label="Remover"></button>
                                    <img src="{{ product.image_url|default('/assets/images/default-product.jpg') }}" 
                                         alt="{{ product.name }}" class="img-fluid mb-2" style="max-height: 150px;">
                                    <h5>{{ product.name }}</h5>
                                </div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Preço</th>
                        {% for product in products %}
                            <td class="text-center">
                                <p class="fw-bold fs-4 text-primary">€{{ product.price|number_format(2, ',', '.') }}</p>
                            </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Descrição</th>
                        {% for product in products %}
                            <td>{{ product.short_description }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Categoria</th>
                        {% for product in products %}
                            <td class="text-center">{{ product.category.name }}</td>
                        {% endfor %}
                    </tr>

                    {% if specifications|length > 0 %}
                        {% for spec_name, spec_values in specifications %}
                            <tr>
                                <th>{{ spec_name }}</th>
                                {% for product in products %}
                                    <td class="text-center">
                                        {% if product.id in spec_values|keys %}
                                            {{ spec_values[product.id] }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    {% endif %}
                    
                    <tr>
                        <th>Avaliação</th>
                        {% for product in products %}
                            <td class="text-center">
                                {% set rating = product.avg_rating|default(0) %}
                                {% for i in 1..5 %}
                                    {% if i <= rating %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% elseif i <= rating + 0.5 %}
                                        <i class="bi bi-star-half text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                                <br>
                                <small>({{ product.review_count|default(0) }} avaliações)</small>
                            </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Ações</th>
                        {% for product in products %}
                            <td class="text-center">
                                <div class="d-grid gap-2">
                                    <a href="/product/show/{{ product.id }}" class="btn btn-primary">Ver Detalhes</a>
                                    <a href="/order/create?product_id={{ product.id }}" class="btn btn-outline-primary">Fazer Pedido</a>
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h4 class="alert-heading">Nenhum produto selecionado para comparação!</h4>
            <p>Para comparar produtos, navegue pelo catálogo e clique no botão "Adicionar à Comparação" nos produtos desejados.</p>
            <hr>
            <p class="mb-0">Veja nosso <a href="/product/categories">catálogo de produtos</a> para começar.</p>
        </div>
    {% endif %}
    
    {% if related_products|length > 0 %}
        <div class="mt-5">
            <h3>Produtos Relacionados para Comparação</h3>
            <div class="row row-cols-1 row-cols-md-4 g-4">
                {% for related in related_products %}
                    {% if related.id not in product_ids %}
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <img src="{{ related.image_url|default('/assets/images/default-product.jpg') }}" 
                                     class="card-img-top" alt="{{ related.name }}"
                                     style="height: 150px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">{{ related.name }}</h5>
                                    <p class="fw-bold text-primary">€{{ related.price|number_format(2, ',', '.') }}</p>
                                </div>
                                <div class="card-footer bg-white border-top-0">
                                    <button class="btn btn-outline-primary w-100" onclick="addToCompare('{{ related.id }}')">
                                        <i class="bi bi-plus-circle me-1"></i> Adicionar à Comparação
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the comparison functionality
    initCompare();
});

function initCompare() {
    // Store current URL for reference
    const currentUrl = new URL(window.location.href);
    window.compareBaseUrl = currentUrl.origin + currentUrl.pathname;
    window.compareIds = getProductIdsFromUrl();
}

function getProductIdsFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const ids = urlParams.get('ids');
    return ids ? ids.split(',') : [];
}

function removeProduct(productId) {
    const compareIds = getProductIdsFromUrl();
    const newIds = compareIds.filter(id => id !== productId);
    
    if (newIds.length > 0) {
        window.location.href = window.compareBaseUrl + '?ids=' + newIds.join(',');
    } else {
        window.location.href = '/product/categories';
    }
}

function addToCompare(productId) {
    const compareIds = getProductIdsFromUrl();
    
    // Check if product is already in comparison
    if (compareIds.includes(productId)) {
        return;
    }
    
    // Add the new product ID
    compareIds.push(productId);
    
    // Redirect to the updated comparison page
    window.location.href = window.compareBaseUrl + '?ids=' + compareIds.join(',');
}
</script>
{% endblock %}