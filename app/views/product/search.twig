{% extends "layout/main.twig" %}

{% block title %}Resultados da Pesquisa: {{ search_term }} - PrintWise{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Início</a></li>
            <li class="breadcrumb-item active" aria-current="page">Pesquisa: {{ search_term }}</li>
        </ol>
    </nav>

    <h1 class="mb-2">Resultados da Pesquisa</h1>
    <p class="lead mb-4">Exibindo resultados para: "<strong>{{ search_term }}</strong>"</p>
    
    <div class="row mb-4">
        <div class="col-md-3 mb-4 mb-md-0">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Refinar Resultados</h5>
                </div>
                <div class="card-body">
                    <form action="/product/search" method="get" id="searchFilterForm">
                        <input type="hidden" name="q" value="{{ search_term }}">
                        
                        <div class="mb-3">
                            <label class="form-label">Ordenar por</label>
                            <select class="form-select" name="sort" onchange="document.getElementById('searchFilterForm').submit()">
                                <option value="relevance" {% if sort == 'relevance' %}selected{% endif %}>Relevância</option>
                                <option value="price_low" {% if sort == 'price_low' %}selected{% endif %}>Preço: Menor para Maior</option>
                                <option value="price_high" {% if sort == 'price_high' %}selected{% endif %}>Preço: Maior para Menor</option>
                                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Mais Recentes</option>
                                <option value="name" {% if sort == 'name' %}selected{% endif %}>Nome (A-Z)</option>
                            </select>
                        </div>
                        
                        {% if categories|length > 0 %}
                        <div class="mb-3">
                            <label class="form-label">Categorias</label>
                            <div class="list-group">
                                {% for category in categories %}
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" name="category[]" value="{{ category.id }}"
                                           {% if category.id in selected_categories %}checked{% endif %}>
                                    {{ category.name }}
                                    <span class="badge bg-secondary float-end">{{ category.count }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="price_range" class="form-label">Preço máximo: €<span id="price_value">{{ max_price }}</span></label>
                            <input type="range" class="form-range" id="price_range" name="max_price" 
                                   min="0" max="{{ price_ceiling }}" step="1" value="{{ max_price }}"
                                   oninput="document.getElementById('price_value').textContent = this.value">
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Tags Populares</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in popular_tags %}
                            <a href="/product/search?q={{ search_term }}&tag={{ tag.name|url_encode }}" class="text-decoration-none">
                                <span class="badge bg-light text-dark border">{{ tag.name }} ({{ tag.count }})</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            {% if products|length > 0 %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>{{ total_count }} produto(s) encontrado(s)</span>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary view-btn" data-view="grid" {% if view_mode == 'grid' %}disabled{% endif %}>
                            <i class="bi bi-grid"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary view-btn" data-view="list" {% if view_mode == 'list' %}disabled{% endif %}>
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>
                
                <div id="grid-view" class="{% if view_mode != 'grid' %}d-none{% endif %}">
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        {% for product in products %}
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <div class="position-relative">
                                        <img src="{{ product.image_url|default('/assets/images/default-product.jpg') }}" 
                                             class="card-img-top" alt="{{ product.name }}"
                                             style="height: 200px; object-fit: cover;">
                                        {% if product.is_featured %}
                                            <span class="position-absolute top-0 start-0 badge bg-primary m-2">Destaque</span>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 compare-btn" 
                                                data-product-id="{{ product.id }}">
                                            <i class="bi bi-plus-circle"></i> Comparar
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <h5 class="card-title">{{ product.name }}</h5>
                                        <p class="card-text text-truncate">{{ product.short_description }}</p>
                                        <p class="fw-bold text-primary">€{{ product.price|number_format(2, ',', '.') }}</p>
                                        
                                        <div class="mb-1">
                                            {% set rating = product.avg_rating|default(0) %}
                                            {% for i in 1..5 %}
                                                {% if i <= rating %}
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                {% elseif i <= rating + 0.5 %}
                                                    <i class="bi bi-star-half text-warning"></i>
                                                {% else %}
                                                    <i class="bi bi-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                            <small class="text-muted">({{ product.review_count|default(0) }})</small>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-white border-top-0">
                                        <div class="d-grid gap-2">
                                            <a href="/product/show/{{ product.id }}" class="btn btn-primary">Ver Detalhes</a>
                                            <a href="/order/create?product_id={{ product.id }}" class="btn btn-outline-primary">Fazer Pedido</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div id="list-view" class="{% if view_mode != 'list' %}d-none{% endif %}">
                    <div class="list-group">
                        {% for product in products %}
                            <div class="list-group-item p-0">
                                <div class="row g-0">
                                    <div class="col-md-3">
                                        <img src="{{ product.image_url|default('/assets/images/default-product.jpg') }}" 
                                             class="img-fluid rounded-start" alt="{{ product.name }}"
                                             style="height: 180px; object-fit: cover; width: 100%;">
                                    </div>
                                    <div class="col-md-9">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <h5 class="card-title">{{ product.name }}</h5>
                                                <button class="btn btn-sm btn-outline-secondary compare-btn" 
                                                        data-product-id="{{ product.id }}">
                                                    <i class="bi bi-plus-circle"></i> Comparar
                                                </button>
                                            </div>
                                            
                                            <div class="mb-1">
                                                {% set rating = product.avg_rating|default(0) %}
                                                {% for i in 1..5 %}
                                                    {% if i <= rating %}
                                                        <i class="bi bi-star-fill text-warning"></i>
                                                    {% elseif i <= rating + 0.5 %}
                                                        <i class="bi bi-star-half text-warning"></i>
                                                    {% else %}
                                                        <i class="bi bi-star text-warning"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <small class="text-muted">({{ product.review_count|default(0) }})</small>
                                            </div>
                                            
                                            <p class="card-text">{{ product.short_description }}</p>
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <p class="fw-bold fs-4 text-primary mb-0">€{{ product.price|number_format(2, ',', '.') }}</p>
                                                <div>
                                                    <a href="/product/show/{{ product.id }}" class="btn btn-primary">Ver Detalhes</a>
                                                    <a href="/order/create?product_id={{ product.id }}" class="btn btn-outline-primary">Fazer Pedido</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if currentPage > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="/product/search?q={{ search_term|url_encode }}&page={{ currentPage - 1 }}{{ query_string }}">Anterior</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Anterior</span>
                                </li>
                            {% endif %}
                            
                            {% for i in 1..totalPages %}
                                <li class="page-item {% if i == currentPage %}active{% endif %}">
                                    <a class="page-link" href="/product/search?q={{ search_term|url_encode }}&page={{ i }}{{ query_string }}">{{ i }}</a>
                                </li>
                            {% endfor %}
                            
                            {% if currentPage < totalPages %}
                                <li class="page-item">
                                    <a class="page-link" href="/product/search?q={{ search_term|url_encode }}&page={{ currentPage + 1 }}{{ query_string }}">Próxima</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Próxima</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h4 class="alert-heading">Nenhum produto encontrado!</h4>
                    <p>Não encontramos produtos que correspondam à sua pesquisa "<strong>{{ search_term }}</strong>".</p>
                    <hr>
                    <p>Sugestões:</p>
                    <ul>
                        <li>Verifique a ortografia das palavras digitadas</li>
                        <li>Tente usar palavras-chave menos específicas</li>
                        <li>Tente categorias relacionadas</li>
                    </ul>
                    <p class="mb-0">Navegue pelo nosso <a href="/product/categories">catálogo completo</a> ou entre em <a href="/contact">contato</a> caso precise de ajuda.</p>
                </div>
            {% endif %}
            
            {% if search_suggestions|length > 0 %}
                <div class="mt-4">
                    <h3>Você quis dizer:</h3>
                    <ul class="list-inline">
                        {% for suggestion in search_suggestions %}
                            <li class="list-inline-item">
                                <a href="/product/search?q={{ suggestion|url_encode }}" class="text-decoration-none">{{ suggestion }}</a>
                            </li>
                            {% if not loop.last %}<li class="list-inline-item">|</li>{% endif %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle view mode (grid/list)
    const viewButtons = document.querySelectorAll('.view-btn');
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const viewMode = this.getAttribute('data-view');
            
            // Update buttons state
            viewButtons.forEach(btn => btn.removeAttribute('disabled'));
            this.setAttribute('disabled', true);
            
            // Update view
            if (viewMode === 'grid') {
                gridView.classList.remove('d-none');
                listView.classList.add('d-none');
                localStorage.setItem('product_view_mode', 'grid');
            } else {
                gridView.classList.add('d-none');
                listView.classList.remove('d-none');
                localStorage.setItem('product_view_mode', 'list');
            }
        });
    });
    
    // Add to compare functionality
    const compareButtons = document.querySelectorAll('.compare-btn');
    compareButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            addToCompare(productId);
        });
    });
    
    // Handle category checkboxes
    const categoryCheckboxes = document.querySelectorAll('input[name="category[]"]');
    categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            document.getElementById('searchFilterForm').submit();
        });
    });
});

// Function to add product to compare list
function addToCompare(productId) {
    // Get existing compare IDs from localStorage
    let compareIds = localStorage.getItem('compare_products');
    compareIds = compareIds ? JSON.parse(compareIds) : [];
    
    // Check if product is already in comparison
    if (!compareIds.includes(productId)) {
        // Add the product if not already in list and max 4 products
        if (compareIds.length < 4) {
            compareIds.push(productId);
            localStorage.setItem('compare_products', JSON.stringify(compareIds));
            
            // Show success message
            alert('Produto adicionado à comparação.');
            
            // Update compare badge if it exists
            updateCompareCount();
        } else {
            alert('Você pode comparar no máximo 4 produtos ao mesmo tempo.');
        }
    } else {
        alert('Este produto já está na sua lista de comparação.');
    }
}

function updateCompareCount() {
    const compareBadge = document.querySelector('#compare-badge');
    if (compareBadge) {
        const compareIds = JSON.parse(localStorage.getItem('compare_products') || '[]');
        compareBadge.textContent = compareIds.length;
        
        if (compareIds.length > 0) {
            compareBadge.classList.remove('d-none');
        } else {
            compareBadge.classList.add('d-none');
        }
    }
}
</script>
{% endblock %}